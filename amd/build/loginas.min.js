define("local_loginas/loginas",["exports","core/modal_factory","core/modal_events","core/ajax","core/templates","core/str"],(function(_exports,Modal,ModalEvents,_ajax,_templates,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}
/**
   * When clicking the login as button, show a modal with a user selector.
   * Selecting a user will log you in as that user.
   *
   * @module     local_loginas/loginas
   * @copyright  2023 Bas Brands <bas@sonsbeekmedia.nl>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,Modal=_interopRequireWildcard(Modal),ModalEvents=_interopRequireWildcard(ModalEvents),_ajax=_interopRequireDefault(_ajax),_templates=_interopRequireDefault(_templates);const results=(input,resultsDiv,courseid)=>{search(input.value).then((async users=>{users.forEach((user=>{const baseUrl=M.cfg.wwwroot+"/course/loginas.php?id="+courseid+"&user="+user.id+"&sesskey="+M.cfg.sesskey+"&redirect=0";user.loginasurl=baseUrl}));const template={users:users},{html:html}=await _templates.default.renderForPromise("local_loginas/loginas",template);if(resultsDiv.innerHTML=html,0===users.length){const messageDiv=document.createElement("div");messageDiv.classList.add("alert","alert-info","my-2"),messageDiv.innerHTML=await(0,_str.get_string)("nousersfound","local_loginas"),resultsDiv.appendChild(messageDiv)}return""})).catch((error=>{window.console.log(error)}))},search=async query=>{const request={methodname:"local_loginas_get_users",args:{query:query}};return(await _ajax.default.call([request]))[0]};var _default={init:async(courseid,showreturn)=>{const usermenu=document.querySelector(".usermenu .dropdown-menu");if(!usermenu)return;document.addEventListener("click",(event=>{event.target.closest('[data-action="loginas"]')&&(event.preventDefault(),(async courseid=>{const{html:html}=await _templates.default.renderForPromise("core/search_input",{uniqueid:0,inputname:"loginas",query:"",searchstring:"username"}),modal=await Modal.create({type:Modal.types.DEFAULT,large:!0,title:"Login As",scrollable:!1,templateContext:{classes:["loginas-modal"]},body:html});modal.getRoot().on(ModalEvents.hidden,(()=>{modal.destroy()})),await modal.show();const modalBody=modal.getRoot().find(".modal-body"),resultsDiv=document.createElement("div");resultsDiv.classList.add("search-results"),modalBody[0].appendChild(resultsDiv);const input=modal.getRoot().find("input")[0];input.addEventListener("keypress",(event=>{13===event.keyCode&&(event.preventDefault(),results(input,resultsDiv,courseid))})),input.addEventListener("submit",(event=>{event.preventDefault(),results(input,resultsDiv,courseid)})),modal.getRoot().find('button[type="submit"]')[0].addEventListener("click",(event=>{event.preventDefault(),results(input,resultsDiv,courseid)}))})(courseid));event.target.closest('[data-action="returntorealuser"]')&&(event.preventDefault(),(async()=>{const request={methodname:"local_loginas_return_to_real_user",args:{sesskey:M.cfg.sesskey}};return(await _ajax.default.call([request]))[0]})().then((()=>(window.location.reload(),""))).catch((error=>{window.console.log(error)})));const loginAsButton=event.target.closest('[data-action="localloginas"]');if(loginAsButton){const userid=loginAsButton.dataset.userid;event.preventDefault(),(async userid=>{const request={methodname:"local_loginas_login_as",args:{userid:userid}};return(await _ajax.default.call([request]))[0]})(userid).then((()=>(window.location.reload(),""))).catch((error=>{window.console.log(error)}))}}));const link=document.createElement("a");link.href=M.cfg.wwwroot+"/local/loginas/index.php?id="+courseid,link.classList.add("dropdown-item","menu-action"),showreturn?(link.dataset.action="returntorealuser",link.innerHTML=await(0,_str.get_string)("returntorealuser","local_loginas")):(link.dataset.action="loginas",link.innerHTML=await(0,_str.get_string)("loginas","local_loginas"));const afterItem=usermenu.querySelector(".dropdown-divider");afterItem.parentNode.insertBefore(link,afterItem.nextSibling)}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=loginas.min.js.map